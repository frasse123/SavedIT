<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>Saved it</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="icon" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=12"/>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
      :root{
        --accent:#0f766e; --accent-2:#0ea5a3;
        --bg:#f6f8fb; --surface:#ffffff;
        --text:#0f172a; --muted:#6b7280;
        --border:#e8eaf0; --ring:rgba(14,165,233,.18);
        --green:#22c55e; --red:#ef4444;
      }
      :root { color-scheme: light; }
      html { -webkit-text-size-adjust: 100%; }
      body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:var(--text); background:var(--bg); }

      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
      input, button, select, textarea { width:100%; max-width:100%; min-width:0; }

      /* Hero */
      .hero{
        background: radial-gradient(1200px 300px at 30% -10%, #bff0ec 0%, transparent 60%),
                    linear-gradient(135deg, #d8f4f1 0%, #eaf6ff 40%, #f7f9ff 100%);
        padding: max(28px, calc(env(safe-area-inset-top) + 18px)) 0 28px;
        border-bottom: 1px solid var(--border);
      }
      .wrap{ max-width: 860px; margin: 0 auto; padding: 0 22px 28px; }
      .top{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 14px; }
      .brand{ display:flex; align-items:center; gap:12px; }
      .logo{ width: 38px; height: 38px; border-radius: 12px; background: conic-gradient(from 200deg, var(--accent), var(--accent-2)); box-shadow: 0 6px 18px rgba(15,118,110,.25), inset 0 1px 3px rgba(255,255,255,.6);}
      .brand h1{ font-size: 30px; line-height:1.1; margin:0; letter-spacing:-0.01em; }
      .subtitle{ color:var(--muted); margin:6px 0 0 50px; }

      .install{ padding:10px 14px; border-radius: 999px; background:#fff; border:1px solid var(--border); box-shadow:0 2px 10px rgba(2,6,23,.06); width:auto; }
      .install[hidden]{ display:none; }

      /* menu button */
      .menu-btn { width:38px; height:38px; border-radius:10px; border:1px solid var(--border); background:#fff; display:flex; align-items:center; justify-content:center; }
      .menu-btn span{ display:block; width:18px; height:2px; background:#0f172a; position:relative; }
      .menu-btn span::before, .menu-btn span::after{ content:""; position:absolute; left:0; width:18px; height:2px; background:#0f172a; }
      .menu-btn span::before{ top:-6px; } .menu-btn span::after{ top:6px; }

      .content{ max-width: 860px; margin: 0 auto; padding: 22px; }

      /* Inputs */
      .row{ display:grid; grid-template-columns: 1fr 160px auto; gap: 10px; margin: 10px 0 18px; }
      @media (max-width: 560px){ .row{ grid-template-columns: 1fr; } }
      input[type="text"], input[type="number"], select, textarea{
        width:100%; padding: 12px 14px; border:1px solid var(--border); border-radius: 12px; background:#fff;
        font-size:17px !important; color:var(--text); caret-color:var(--text);
        outline:none; transition: border-color .15s, box-shadow .15s; box-shadow: 0 1px 0 rgba(15,23,42,.03);
      }
      input::placeholder, textarea::placeholder{ color:#9aa0a6; opacity:1; }
      input:focus, select:focus, textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring); }
      input:-webkit-autofill{ -webkit-text-fill-color: var(--text) !important; box-shadow: 0 0 0 1000px #fff inset; -webkit-box-shadow: 0 0 0 1000px #fff inset; }

      .btn{ padding: 11px 14px; border-radius: 12px; border:1px solid var(--border); background:#fff; color:var(--text); cursor:pointer; font-weight:600; transition: transform .06s, box-shadow .15s; box-shadow: 0 1px 0 rgba(15,23,42,.05); width:auto; }
      .btn:active{ transform: translateY(1px); }
      .btn-add{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; border-color:transparent; box-shadow: 0 8px 20px rgba(15,118,110,.25); }

      .card{ background: var(--surface); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 2px 12px rgba(15,23,42,.06); }
      .list-item{ display:flex; align-items:center; justify-content:space-between; gap:14px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
      .list-item:last-child{ border-bottom: 0; }

      .actions{ display:flex; gap: 8px; }
      .save   { background: #22c55e; border-color:#22c55e; color:#fff; }
      .danger { background: #ef4444; border-color:#ef4444; color:#fff; }

      .section{ display:flex; align-items:center; justify-content:space-between; margin: 22px 0 12px; }
      .section h3{ margin:0; font-size: 16px; letter-spacing: .02em; color:#111; }
      .muted{ color:var(--muted); font-style:italic; text-align:center; margin:12px 0; }

      /* Tabs */
      .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 6px; }
      .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-weight:600; color:#334155; }
      .tab.active{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; border-color:transparent; }

      /* Summary */
      .summary{ display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin:12px 0 16px; }
      @media (max-width: 560px){ .summary{ grid-template-columns: 1fr; } }
      .sum-card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px 14px; box-shadow:0 2px 10px rgba(15,23,42,.04); }
      .sum-label{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.04em; margin-bottom:6px; }
      .sum-value{ font-size:18px; font-weight:700; }

      /* Bars */
      .bars{ display:flex; align-items:flex-end; gap:6px; padding:10px 6px; height:68px; }
      .bar{ flex:1; background:linear-gradient(180deg, rgba(15,118,110,.9), rgba(15,118,110,.5)); border-radius:6px; min-width:6px; }

      .stats{ position: sticky; bottom: 0; margin-top: 18px; padding: 14px 16px; background: var(--surface); border:1px solid var(--border); border-radius: 14px; box-shadow: 0 -1px 10px rgba(15,23,42,.06); position: static !important; }
      .empty{ text-align:center; color: var(--muted); padding: 18px 10px; }

      /* Drawer */
      .drawer{ position:fixed; inset:0; background:rgba(2,6,23,.28); display:none; }
      .drawer.open{ display:block; }
      .panel{ position:absolute; top:0; left:0; width:280px; max-width:85%; height:100%; background:#fff; border-right:1px solid var(--border); box-shadow: 0 4px 24px rgba(2,6,23,.15); padding:18px; }
      .panel h4{ margin:0 0 8px; }
      .nav-btn{ display:block; width:100%; text-align:left; margin:6px 0; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; font-weight:600; }
      .nav-btn.active{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; border-color:transparent; }

      /* Goals */
      .goal-form{ display:grid; grid-template-columns: 1fr 160px auto; gap:10px; margin-bottom:10px; }
      @media (max-width:560px){ .goal-form{ grid-template-columns:1fr; } }
      .goal-card{ padding:14px; border:1px solid var(--border); border-radius:14px; background:#fff; margin:12px 0; }
      .goal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .progress{ height:10px; border-radius:999px; background:#eef2f7; overflow:hidden; }
      .progress > div{ height:100%; background:linear-gradient(135deg, var(--accent), var(--accent-2)); }

      .chips{ display:flex; flex-wrap:wrap; gap:6px; margin:8px 0;}
      .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px; }
      .goal-actions{ display:flex; gap:8px; margin-top:10px;}
      
      /* Simple table list */
      .table{ width:100%; border-collapse: collapse; }
      .table tr{ border-bottom:1px solid var(--border); }
      .table td{ padding:10px 0; }
      .right{ text-align:right; }
      .row-sm{ display:flex; gap:8px; }
      .note{ font-size:12px; color:var(--muted);}
      .pill{ padding:4px 8px; border-radius:999px; background:#eef2f7; border:1px solid var(--border); font-size:12px; }
    </style>
  </head>

  <body>
    <header class="hero">
      <div class="wrap">
        <div class="top">
          <button id="menuBtn" class="menu-btn" aria-label="Meny"><span></span></button>
          <div class="brand">
            <div class="logo"></div>
            <h1>Saved it</h1>
          </div>
          <button id="installBtn" class="install btn" hidden>Installera appen</button>
        </div>
        <p class="subtitle">Logga impulsköp du avstår. Spara pengar. Allt lagras lokalt på enheten.</p>
      </div>
    </header>

    <main class="content">
      <div id="root"></div>
    </main>

    <!-- Drawer -->
    <div id="drawer" class="drawer" aria-hidden="true">
      <div class="panel">
        <h4>Meny</h4>
        <button class="nav-btn" data-view="log">Logg & översikt</button>
        <button class="nav-btn" data-view="goals">Sparmål</button>
        <button class="nav-btn" data-view="insights">Insikter</button>
        <button class="nav-btn" data-view="history">Historik</button>
        <button class="nav-btn" data-view="categories">Kategorier</button>
        <button class="nav-btn" data-view="settings">Inställningar</button>
        <button class="nav-btn" data-view="about">Om</button>
        <button class="nav-btn" data-view="feedback">Feedback</button>
      </div>
    </div>

    <!-- React via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const FEEDBACK_EMAIL = "din@epost.se"; // <-- BYT TILL DIN ADRESS

      const { useState, useEffect, useMemo } = React;

      // Helpers
      const load = (k, f) => { try{ const v = localStorage.getItem(k); return v? JSON.parse(v): f; } catch { return f; } };
      const saveLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));

      // Dates
      const toDate = (iso) => new Date(iso);
      const stripTime = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const startOfWeek = (d) => { const day = d.getDay(); const diff = (day === 0 ? -6 : 1) - day; const s = new Date(d); s.setDate(d.getDate()+diff); return stripTime(s); };
      const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
      const startOfYear  = (d) => new Date(d.getFullYear(), 0, 1);
      const isInRange = (date, start) => stripTime(date) >= stripTime(start);

      function App(){
        // Core data
        const [items, setItems]   = useState(() => load("items", []));
        const [saved, setSaved]   = useState(() => load("saved", []));
        const [newName, setNewName] = useState("");
        const [newPrice, setNewPrice] = useState("");
        const [tab, setTab] = useState("week"); // week | month | year | all

        // Goals
        const [goals, setGoals] = useState(() => load("goals", []));
        // Categories
        const [categories, setCategories] = useState(() => load("categories", []));
        // Settings
        const [settings, setSettings] = useState(() => load("settings", { currency:"kr", weekStartsOn:"monday", notifications:{weeklySummary:{enabled:false, day:0, time:"18:00"}} }));

        // View
        const [view, setView] = useState("log"); // log | goals | insights | history | categories | settings | about | feedback

        // Stäng av sticky-footer när ett inputfält är fokus (iOS/Safari)
useEffect(() => {
  const onFocusIn = (e) => {
    const t = e.target && e.target.tagName;
    if (t === 'INPUT' || t === 'TEXTAREA' || t === 'SELECT') {
      document.body.classList.add('kb-open');
    }
  };
  const onFocusOut = (e) => {
    const t = e.target && e.target.tagName;
    if (t === 'INPUT' || t === 'TEXTAREA' || t === 'SELECT') {
      document.body.classList.remove('kb-open');
    }
  };
  window.addEventListener('focusin', onFocusIn);
  window.addEventListener('focusout', onFocusOut);
  return () => {
    window.removeEventListener('focusin', onFocusIn);
    window.removeEventListener('focusout', onFocusOut);
  };
}, []);

        useEffect(()=>saveLS("items", items), [items]);
        useEffect(()=>saveLS("saved", saved), [saved]);
        useEffect(()=>saveLS("goals", goals), [goals]);
        useEffect(()=>saveLS("categories", categories), [categories]);
        useEffect(()=>saveLS("settings", settings), [settings]);

        // ------- items / saved -------
        const addItem = () => {
          if(!newName.trim() || !newPrice.trim()){ alert("Fyll i både namn och pris"); return; }
          const price = Number(newPrice.replace(",", ".")); if(Number.isNaN(price) || price <= 0){ alert("Ange ett giltigt pris"); return; }
          setItems(prev => [...prev, { id: String(Date.now()), name: newName.trim(), price, categoryId:null }]);
          setNewName(""); setNewPrice("");
        };
        const removeItem = (id) => setItems(prev => prev.filter(i => i.id !== id));

        // When saving money we also update linked goals
        const saveMoney  = (item) => {
          const entry = { ...item, sid:String(Date.now()), date:new Date().toISOString() };
          setSaved(prev => [entry, ...prev]);
          setGoals(prev => prev.map(g => (
            g.itemIds?.includes(item.id)
              ? { ...g, amount: (g.amount||0) + (Number(item.price)||0),
                  deposits:[...(g.deposits||[]), {date:entry.date, amount:+item.price, source:item.name}] }
              : g
          )));
        };
        const deleteSaved= (sid) => setSaved(prev => prev.filter(s => s.sid !== sid));
        const clearHistory = () => { if(confirm("Rensa hela historiken?")) setSaved([]); };

        // ------- filters / summaries -------
        const today = new Date();
        const periodStart = useMemo(() => {
          if(tab === "week")  return startOfWeek(today);
          if(tab === "month") return startOfMonth(today);
          if(tab === "year")  return startOfYear(today);
          return new Date(0);
        }, [tab]);

        const filtered = useMemo(() => saved.filter(s => isInRange(toDate(s.date), periodStart)), [saved, periodStart]);
        const totalSavedAll   = useMemo(() => saved.reduce((a,s)=>a+(+s.price||0), 0), [saved]);
        const totalSavedPeriod= useMemo(() => filtered.reduce((a,s)=>a+(+s.price||0), 0), [filtered]);

        const bars = useMemo(() => {
          const map = new Map();
          for(const s of filtered){
            const key = stripTime(toDate(s.date)).toISOString();
            map.set(key, (map.get(key)||0) + (+s.price||0));
          }
          const arr = Array.from(map.entries()).sort((a,b)=> new Date(a[0])-new Date(b[0]));
          const values = arr.map(x=>x[1]);
          const max = Math.max(...values, 1);
          return arr.map(([k,v]) => ({ date:new Date(k), h: Math.max(6, Math.round(60*v/max)) }));
        }, [filtered]);

        const tabLabel = { week:"Vecka", month:"Månad", year:"År", all:"Alla" }[tab];

        /* --------- VIEWS ---------- */

        const LogView = () => (
          <>
            <div className="row">
              <input type="text" placeholder="Namn (t.ex. Latte)" value={newName} onChange={e=>setNewName(e.target.value)} />
              <input type="number" step="0.01" placeholder="Pris" value={newPrice} onChange={e=>setNewPrice(e.target.value)} />
              <button className="btn btn-add" onClick={addItem}>Lägg till</button>
            </div>

            {items.length === 0 && <div className="empty">Inga impulsköp tillagda ännu.</div>}
            {items.length > 0 && (
              <div className="card">
                {items.map(item => (
                  <div className="list-item" key={item.id}>
                    <div>
                      <strong>{item.name}</strong> <span className="muted">({item.price} {settings.currency})</span>
                      {item.categoryId && <span className="pill" style={{marginLeft:8}}>{categories.find(c=>c.id===item.categoryId)?.emoji || ""} {categories.find(c=>c.id===item.categoryId)?.name || ""}</span>}
                    </div>
                    <div className="actions">
                      <button className="btn save" onClick={()=>saveMoney(item)}>Avstod</button>
                      <button className="btn danger" onClick={()=>removeItem(item.id)}>Ta bort</button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div className="section"><h3>Översikt</h3></div>
            <div className="tabs">
              {["week","month","year","all"].map(key => (
                <button key={key} className={"tab"+(tab===key?" active":"")} onClick={()=>setTab(key)}>
                  {({week:"Vecka",month:"Månad",year:"År",all:"Alla"})[key]}
                </button>
              ))}
            </div>

            <div className="summary">
              <div className="sum-card">
                <div className="sum-label">Totalt sparat – {tabLabel.toLowerCase()}</div>
                <div className="sum-value">{totalSavedPeriod.toFixed(2)} {settings.currency}</div>
              </div>
              <div className="sum-card">
                <div className="sum-label">Antal avståenden</div>
                <div className="sum-value">{filtered.length}</div>
              </div>
              <div className="sum-card">
                <div className="sum-label">Totalt (alla tider)</div>
                <div className="sum-value">{totalSavedAll.toFixed(2)} {settings.currency}</div>
              </div>
            </div>

            {filtered.length > 0 && (
              <div className="card" style={{padding:"6px 8px"}}>
                <div style={{ padding:'6px 10px', fontWeight:600, color:'#334155' }}>Logg för {tabLabel.toLowerCase()}</div>
                <div className="bars">
                  {bars.map((b, i) => (
                    <div key={i} className="bar" style={{height:b.h+'px'}} title={b.date.toLocaleDateString()}></div>
                  ))}
                </div>
              </div>
            )}

            <div className="section">
              <h3>Historik – {tabLabel.toLowerCase()}</h3>
              {saved.length > 0 && <button className="btn danger" onClick={clearHistory}>Rensa all historik</button>}
            </div>

            {filtered.length === 0 && <div className="empty">Du har inte avstått något i vald period.</div>}
            {filtered.length > 0 && (
              <div className="card">
                {filtered.slice(0,100).map(s => (
                  <div className="list-item" key={s.sid}>
                    <div><strong>{s.name}</strong> <span className="muted">{s.price} {settings.currency}</span></div>
                    <div className="actions">
                      <span className="muted" style={{alignSelf:"center"}}>{new Date(s.date).toLocaleString()}</span>
                      <button className="btn danger" onClick={()=>deleteSaved(s.sid)}>Ta bort</button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div className="stats"><b>Totalt sparat: {totalSavedAll.toFixed(2)} {settings.currency}</b></div>
          </>
        );

        /* ------------ GOALS ------------ */
        const [gName, setGName] = useState("");
        const [gTarget, setGTarget] = useState("");
        const [gChecked, setGChecked] = useState({}); // itemId -> bool
        const resetGoalForm = () => { setGName(""); setGTarget(""); setGChecked({}); };

        const createGoal = () => {
          if(!gName.trim() || !gTarget.trim()){ alert("Fyll i namn och målbelopp"); return; }
          const target = Number(gTarget.replace(",", ".")); if(Number.isNaN(target) || target <= 0){ alert("Ange ett giltigt målbelopp"); return; }
          const itemIds = Object.entries(gChecked).filter(([,v])=>v).map(([k])=>k);
          const goal = { id:String(Date.now()), name:gName.trim(), target, amount:0, itemIds, deposits:[] };
          setGoals(prev => [goal, ...prev]); resetGoalForm();
        };
        const removeGoal = (id) => { if(confirm("Ta bort det här målet?")) setGoals(prev => prev.filter(g => g.id !== id)); };
        const addDeposit = (id, amount) => {
          const num = Number(String(amount).replace(",", ".")); if(Number.isNaN(num) || num <= 0){ alert("Ogiltigt belopp"); return; }
          const date = new Date().toISOString();
          setGoals(prev => prev.map(g => g.id === id ? { ...g, amount:(g.amount||0)+num, deposits:[...(g.deposits||[]), {date, amount:num, source:"Manuell"}] } : g));
        };
        const toggleLink = (goalId, itemId, checked) => {
          setGoals(prev => prev.map(g => {
            if(g.id !== goalId) return g;
            const set = new Set(g.itemIds || []);
            if(checked) set.add(itemId); else set.delete(itemId);
            return { ...g, itemIds:[...set] };
          }));
        };
        const GoalDepositInput = ({onAdd}) => {
          const [val, setVal] = useState("");
          return (
            <div className="row-sm">
              <input type="number" step="0.01" placeholder="Insättning (kr)" value={val} onChange={e=>setVal(e.target.value)} />
              <button className="btn" onClick={()=>{ onAdd(val); setVal(""); }}>Lägg till insättning</button>
            </div>
          );
        };

        const GoalsView = () => (
          <>
            <div className="card" style={{padding:"14px"}}>
              <div className="goal-form">
                <input type="text" placeholder="Namn på mål (t.ex. Resa)" value={gName} onChange={e=>setGName(e.target.value)} />
                <input type="number" step="0.01" placeholder={`Målsumma (${settings.currency})`} value={gTarget} onChange={e=>setGTarget(e.target.value)} />
                <button className="btn btn-add" onClick={createGoal}>Skapa mål</button>
              </div>
              <div className="muted" style={{marginTop:6}}>Välj vilka impulsköp som ska kopplas till detta mål:</div>
              <div className="chips">
                {items.length === 0 && <span className="muted">Inga impulsköp tillagda ännu.</span>}
                {items.map(i => (
                  <label key={i.id} className="chip" style={{cursor:"pointer"}}>
                    <input type="checkbox" checked={!!gChecked[i.id]} onChange={e=>setGChecked(s=>({...s, [i.id]:e.target.checked}))} style={{marginRight:8}} />
                    {i.name} ({i.price} {settings.currency})
                  </label>
                ))}
              </div>
            </div>

            {goals.length === 0 && <div className="empty">Inga mål ännu. Skapa ditt första ovan! ✨</div>}
            {goals.map(goal => {
              const pct = Math.min(100, Math.round((goal.amount||0) / (goal.target||1) * 100));
              return (
                <div key={goal.id} className="goal-card">
                  <div className="goal-head">
                    <div>
                      <strong>{goal.name}</strong>
                      <div className="muted">Mål: {goal.target.toFixed ? goal.target.toFixed(2) : goal.target} {settings.currency} · Sparat: {(goal.amount||0).toFixed(2)} {settings.currency} ({pct}%)</div>
                    </div>
                    <button className="btn danger" onClick={()=>removeGoal(goal.id)}>Ta bort</button>
                  </div>
                  <div className="progress" style={{margin:"10px 0 8px"}}><div style={{width:pct+"%"}}></div></div>

                  <div className="muted">Kopplade impulsköp</div>
                  <div className="chips">
                    {items.length === 0 && <span className="muted">Inga impulsköp i listan.</span>}
                    {items.map(i => {
                      const checked = !!(goal.itemIds||[]).includes(i.id);
                      return (
                        <label key={i.id} className="chip" style={{cursor:"pointer"}}>
                          <input type="checkbox" checked={checked} onChange={(e)=>toggleLink(goal.id, i.id, e.target.checked)} style={{marginRight:8}}/>
                          {i.name} ({i.price} {settings.currency})
                        </label>
                      );
                    })}
                  </div>

                  <div className="goal-actions"><GoalDepositInput onAdd={amt=>addDeposit(goal.id, amt)} /></div>
                </div>
              );
            })}
          </>
        );

        /* ---------- INSIGHTS ---------- */
        const InsightsView = () => {
          const byItem = useMemo(() => {
            const map = new Map();
            for(const r of saved){ map.set(r.name, (map.get(r.name)||0)+(+r.price||0)); }
            return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
          }, [saved]);

          const weekSaved = saved.filter(s=>isInRange(toDate(s.date), startOfWeek(today))).reduce((a,s)=>a+(+s.price||0),0);
          const monthSaved = saved.filter(s=>isInRange(toDate(s.date), startOfMonth(today))).reduce((a,s)=>a+(+s.price||0),0);
          const yearSaved = saved.filter(s=>isInRange(toDate(s.date), startOfYear(today))).reduce((a,s)=>a+(+s.price||0),0);

          const barsAll = useMemo(() => {
            // 14 senaste dagarna
            const now = stripTime(today);
            const days = [...Array(14)].map((_,i)=> new Date(now.getTime() - (13-i)*86400000));
            const arr = days.map(d=>{
              const tot = saved.filter(s => stripTime(toDate(s.date)).getTime()===stripTime(d).getTime()).reduce((a,s)=>a+(+s.price||0),0);
              return { date:d, h: tot };
            });
            const max = Math.max(...arr.map(a=>a.h),1);
            return arr.map(a=> ({...a, h: Math.max(6, Math.round(60*a.h/max))}));
          }, [saved]);

          return (
            <>
              <div className="summary">
                <div className="sum-card"><div className="sum-label">Denna vecka</div><div className="sum-value">{weekSaved.toFixed(2)} {settings.currency}</div></div>
                <div className="sum-card"><div className="sum-label">Denna månad</div><div className="sum-value">{monthSaved.toFixed(2)} {settings.currency}</div></div>
                <div className="sum-card"><div className="sum-label">Detta år</div><div className="sum-value">{yearSaved.toFixed(2)} {settings.currency}</div></div>
              </div>

              <div className="card" style={{padding:"6px 8px", marginBottom:12}}>
                <div style={{ padding:'6px 10px', fontWeight:600, color:'#334155' }}>Senaste 14 dagarna</div>
                <div className="bars">
                  {barsAll.map((b, i) => <div key={i} className="bar" style={{height:b.h+'px'}} title={b.date.toLocaleDateString()}></div>)}
                </div>
              </div>

              <div className="card" style={{padding:14}}>
                <div style={{ fontWeight:600, marginBottom:8 }}>Topp 5 avståenden</div>
                {byItem.length===0 && <div className="muted">Inget att visa ännu.</div>}
                {byItem.length>0 && (
                  <table className="table">
                    <tbody>
                      {byItem.map(([name,sum])=>(
                        <tr key={name}><td>{name}</td><td className="right">{sum.toFixed(2)} {settings.currency}</td></tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            </>
          );
        };

        /* ---------- HISTORY ---------- */
        const [q, setQ] = useState("");
        const [catFilter, setCatFilter] = useState("all");
        const hist = useMemo(() => {
          return saved.filter(s => {
            const okQ = q.trim()? s.name.toLowerCase().includes(q.trim().toLowerCase()): true;
            const item = items.find(i=>i.id===s.id) || items.find(i=>i.name===s.name);
            const okC = (catFilter==="all") ? true : (item && item.categoryId===catFilter);
            return okQ && okC;
          });
        }, [saved,q,catFilter,items]);

        const exportJSON = () => {
          const blob = new Blob([JSON.stringify(saved,null,2)], {type:"application/json"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href=url; a.download="saved-history.json"; a.click(); URL.revokeObjectURL(url);
        };
        const exportCSV = () => {
          const rows = [["date","name","price"]];
          saved.forEach(s=> rows.push([s.date,s.name,s.price]));
          const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
          const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href=url; a.download="saved-history.csv"; a.click(); URL.revokeObjectURL(url);
        };

        const HistoryView = () => (
          <>
            <div className="card" style={{padding:14, marginBottom:12}}>
              <div className="row-sm">
                <input type="text" placeholder="Sök i namn..." value={q} onChange={e=>setQ(e.target.value)} />
                <select value={catFilter} onChange={e=>setCatFilter(e.target.value)}>
                  <option value="all">Alla kategorier</option>
                  {categories.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                </select>
                <button className="btn" onClick={exportCSV}>Exportera CSV</button>
                <button className="btn" onClick={exportJSON}>Exportera JSON</button>
              </div>
            </div>

            {hist.length===0 && <div className="empty">Ingen historik matchar filtren.</div>}
            {hist.length>0 && (
              <div className="card">
                {hist.slice(0,300).map(s => (
                  <div className="list-item" key={s.sid}>
                    <div><strong>{s.name}</strong> <span className="muted">{s.price} {settings.currency}</span></div>
                    <div className="actions">
                      <span className="muted" style={{alignSelf:"center"}}>{new Date(s.date).toLocaleString()}</span>
                      <button className="btn danger" onClick={()=>deleteSaved(s.sid)}>Ta bort</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </>
        );

        /* ---------- CATEGORIES ---------- */
        const [cName, setCName] = useState("");
        const [cEmoji, setCEmoji] = useState("🏷️");
        const createCat = () => {
          if(!cName.trim()){ alert("Ange namn"); return; }
          setCategories(prev => [{id:String(Date.now()), name:cName.trim(), emoji:cEmoji}, ...prev]);
          setCName("");
        };
        const removeCat = (id) => {
          if(!confirm("Ta bort kategorin? (items behåller pris men tappar kategori)")) return;
          setCategories(prev => prev.filter(c=>c.id!==id));
          setItems(prev => prev.map(i => i.categoryId===id ? {...i, categoryId:null} : i));
        };

        const CategoriesView = () => (
          <>
            <div className="card" style={{padding:14}}>
              <div className="row-sm">
                <input placeholder="Ny kategori (t.ex. Kaffe)" value={cName} onChange={e=>setCName(e.target.value)} />
                <input placeholder="Emoji (t.ex. ☕)" value={cEmoji} onChange={e=>setCEmoji(e.target.value)} />
                <button className="btn btn-add" onClick={createCat}>Skapa</button>
              </div>
              <div className="note" style={{marginTop:6}}>Koppla items nedan till en kategori.</div>
            </div>

            <div className="card" style={{padding:14, marginTop:12}}>
              <div style={{fontWeight:600, marginBottom:8}}>Kategorier</div>
              {categories.length===0 && <div className="muted">Inga kategorier ännu.</div>}
              {categories.map(c=>(
                <div className="list-item" key={c.id}>
                  <div><span className="pill">{c.emoji}</span> <strong style={{marginLeft:6}}>{c.name}</strong></div>
                  <button className="btn danger" onClick={()=>removeCat(c.id)}>Ta bort</button>
                </div>
              ))}
            </div>

            <div className="card" style={{padding:14, marginTop:12}}>
              <div style={{fontWeight:600, marginBottom:8}}>Koppla items</div>
              {items.length===0 && <div className="muted">Inga items ännu.</div>}
              {items.map(i=>(
                <div className="list-item" key={i.id}>
                  <div><strong>{i.name}</strong> <span className="muted">({i.price} {settings.currency})</span></div>
                  <div style={{minWidth:200}}>
                    <select value={i.categoryId||""} onChange={e=>{
                      const val = e.target.value || null;
                      setItems(prev => prev.map(x => x.id===i.id ? {...x, categoryId:val}: x));
                    }}>
                      <option value="">Ingen kategori</option>
                      {categories.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                    </select>
                  </div>
                </div>
              ))}
            </div>
          </>
        );

        /* ---------- SETTINGS ---------- */
        const SettingsView = () => (
          <>
            <div className="card" style={{padding:14}}>
              <div style={{fontWeight:600, marginBottom:10}}>Allmänt</div>
              <div className="row-sm">
                <select value={settings.currency} onChange={e=>setSettings(s=>({...s, currency:e.target.value}))}>
                  <option value="kr">kr</option><option value="€">€</option><option value="$">$</option><option value="£">£</option>
                </select>
                <select value={settings.weekStartsOn} onChange={e=>setSettings(s=>({...s, weekStartsOn:e.target.value}))}>
                  <option value="monday">Vecka start: Måndag</option>
                  <option value="sunday">Vecka start: Söndag</option>
                </select>
              </div>
            </div>

            <div className="card" style={{padding:14, marginTop:12}}>
              <div style={{fontWeight:600, marginBottom:10}}>Notiser (placeholder)</div>
              <div className="row-sm">
                <label className="chip" style={{display:"flex",alignItems:"center",gap:8}}>
                  <input type="checkbox"
                         checked={!!settings.notifications.weeklySummary.enabled}
                         onChange={e=>setSettings(s=>({...s, notifications:{...s.notifications, weeklySummary:{...s.notifications.weeklySummary, enabled:e.target.checked}}}))}/>
                  Veckosummering
                </label>
                <select value={settings.notifications.weeklySummary.day}
                        onChange={e=>setSettings(s=>({...s, notifications:{...s.notifications, weeklySummary:{...s.notifications.weeklySummary, day:+e.target.value}}}))}>
                  <option value="0">Söndag</option><option value="1">Måndag</option><option value="2">Tisdag</option><option value="3">Onsdag</option><option value="4">Torsdag</option><option value="5">Fredag</option><option value="6">Lördag</option>
                </select>
                <input type="time" value={settings.notifications.weeklySummary.time}
                       onChange={e=>setSettings(s=>({...s, notifications:{...s.notifications, weeklySummary:{...s.notifications.weeklySummary, time:e.target.value}}}))}/>
              </div>
              <div className="note" style={{marginTop:6}}>Notiser kräver tillstånd och en push-tjänst. Vi kan koppla på OneSignal senare.</div>
            </div>

            <div className="card" style={{padding:14, marginTop:12}}>
              <div style={{fontWeight:600, marginBottom:10}}>Data</div>
              <div className="row-sm">
                <button className="btn" onClick={()=>{
                  const blob = new Blob([JSON.stringify({items,saved,goals,categories,settings},null,2)],{type:"application/json"});
                  const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="saved-it-backup.json"; a.click(); URL.revokeObjectURL(url);
                }}>Exportera backup</button>
                <label className="btn" style={{display:"inline-flex",alignItems:"center",gap:8,cursor:"pointer"}}>
                  Importera backup
                  <input type="file" accept="application/json" style="display:none" onChange={async e=>{
                    const file = e.target.files?.[0]; if(!file) return;
                    const text = await file.text(); try{
                      const data = JSON.parse(text);
                      if(confirm("Importera backup och ersätt nuvarande data?")){
                        saveLS("items", data.items||[]); saveLS("saved", data.saved||[]);
                        saveLS("goals", data.goals||[]); saveLS("categories", data.categories||[]);
                        saveLS("settings", data.settings||settings); location.reload();
                      }
                    }catch(err){ alert("Ogiltig fil."); }
                  }}/>
                </label>
                <button className="btn danger" onClick={()=>{ if(confirm("Återställ allt?")){ localStorage.clear(); location.reload(); } }}>Återställ allt</button>
              </div>
            </div>
          </>
        );

        /* ---------- ABOUT ---------- */
        const AboutView = () => (
          <div className="card" style={{padding:14}}>
            <h3 style={{marginTop:0}}>Om</h3>
            <p><b>Saved it</b> hjälper dig spara pengar genom att logga impulsköp du avstår. All data lagras lokalt på din enhet.</p>
            <p className="note">Tips (iPhone): Lägg först till sidan på hemskärmen, öppna därifrån och aktivera ev. notiser i menyn.</p>
            <p className="note">Version: 1.0.0</p>
          </div>
        );

        /* ---------- FEEDBACK ---------- */
        const [fb, setFb] = useState({subject:"", message:"", email:""});
        const FeedbackView = () => {
          const mailto = `mailto:${encodeURIComponent(FEEDBACK_EMAIL)}?subject=${encodeURIComponent(fb.subject||"Saved it – feedback")}&body=${encodeURIComponent(`${fb.message||""}\n\n—\nE-post: ${fb.email||"-"}`)}`;
          return (
            <div className="card" style={{padding:14}}>
              <h3 style={{marginTop:0}}>Feedback</h3>
              <div className="row-sm" style={{marginBottom:8}}><input placeholder="Ämne" value={fb.subject} onChange={e=>setFb(s=>({...s,subject:e.target.value}))}/></div>
              <div className="row-sm" style={{marginBottom:8}}><textarea rows="6" placeholder="Dina tankar/förslag…" value={fb.message} onChange={e=>setFb(s=>({...s,message:e.target.value}))}></textarea></div>
              <div className="row-sm" style={{marginBottom:12}}><input placeholder="Din e-post (valfritt)" value={fb.email} onChange={e=>setFb(s=>({...s,email:e.target.value}))}/></div>
              <a className="btn btn-add" href={mailto}>Skicka via e-post</a>
              <div className="note" style={{marginTop:8}}>Knappen öppnar din e-postklient med texten förifylld.</div>
            </div>
          );
        };

        /* ---------- RENDER ---------- */
        return (
          <>
            {view === "log"        && <LogView />}
            {view === "goals"      && <GoalsView />}
            {view === "insights"   && <InsightsView />}
            {view === "history"    && <HistoryView />}
            {view === "categories" && <CategoriesView />}
            {view === "settings"   && <SettingsView />}
            {view === "about"      && <AboutView />}
            {view === "feedback"   && <FeedbackView />}

            <Drawer current={view} onChange={setView} />
          </>
        );
      }

      function Drawer({current, onChange}){
        React.useEffect(() => {
          const el = document.getElementById("drawer");
          const btn = document.getElementById("menuBtn");
          const close = (e) => { if(e.target === el) el.classList.remove("open"); };
          const open  = () => el.classList.add("open");
          el.addEventListener("click", close);
          btn.addEventListener("click", open);
          return () => { el.removeEventListener("click", close); btn.removeEventListener("click", open); };
        }, []);
        React.useEffect(() => {
          const buttons = document.querySelectorAll('#drawer .nav-btn');
          buttons.forEach(b => {
            b.classList.toggle('active', b.dataset.view === current);
            b.onclick = () => {
              onChange(b.dataset.view);
              document.getElementById("drawer").classList.remove("open");
            };
          });
        }, [current, onChange]);
        return null;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);

      // PWA: install
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('installBtn');
        btn.hidden = false;
        btn.onclick = async () => {
          btn.disabled = true;
          await deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          btn.hidden = true;
          deferredPrompt = null;
        };
      });

      // Service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js');
        });
      }
    </script>
  </body>
</html>

